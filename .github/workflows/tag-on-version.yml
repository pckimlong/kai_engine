name: Tag On Version

on:
  push:
    branches: [main]
    paths:
      - "packages/*/pubspec.yaml"
      - "packages/*/CHANGELOG.md"
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  tag:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create tags and trigger publish
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch --tags --force

          for pubspec in packages/*/pubspec.yaml; do
            pkg_dir="$(dirname "$pubspec")"
            pkg_name="$(basename "$pkg_dir")"
            version="$(awk '/^version:/ {print $2; exit}' "$pubspec")"
            changelog="$pkg_dir/CHANGELOG.md"
            tag="${pkg_name}-v${version}"

            if git show-ref --tags --verify --quiet "refs/tags/$tag"; then
              continue
            fi

            if [ ! -f "$changelog" ]; then
              echo "Missing $changelog; skipping $pkg_name"
              continue
            fi

            if ! grep -qE "^## \\[$version\\]" "$changelog"; then
              echo "No changelog entry for $pkg_name $version; skipping tag."
              continue
            fi

            echo "Creating tag $tag"
            git tag -a "$tag" -m "Release $tag"
            git push origin "$tag"

            # Extract changelog for this version
            changelog_content=$(awk "/^## \\[$version\\]/,/^## \\[/" "$changelog" | head -n -1)

            # Create GitHub Release
            gh release create "$tag" \
              --title "$pkg_name v$version" \
              --notes "$changelog_content" \
              --verify-tag

            # Trigger publish workflow FROM the tag ref (so OIDC gets refType=tag)
            echo "Triggering pub-publish workflow for $tag"
            gh workflow run pub-publish.yml --ref "$tag"
          done
