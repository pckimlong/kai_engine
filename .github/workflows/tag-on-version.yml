name: Tag On Version

on:
  push:
    branches: [main]
    paths:
      - "packages/*/pubspec.yaml"
      - "packages/*/CHANGELOG.md"
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

jobs:
  tag:
    runs-on: ubuntu-latest
    outputs:
      kai_engine: ${{ steps.check.outputs.kai_engine }}
      kai_engine_firebase_ai: ${{ steps.check.outputs.kai_engine_firebase_ai }}
      kai_engine_chat_ui: ${{ steps.check.outputs.kai_engine_chat_ui }}
      prompt_block: ${{ steps.check.outputs.prompt_block }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create missing tags for current versions
        id: check
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch --tags --force

          created_any=false

          for pubspec in packages/*/pubspec.yaml; do
            pkg_dir="$(dirname "$pubspec")"
            pkg_name="$(basename "$pkg_dir")"
            version="$(awk '/^version:/ {print $2; exit}' "$pubspec")"
            changelog="$pkg_dir/CHANGELOG.md"
            tag="${pkg_name}-v${version}"

            if git show-ref --tags --verify --quiet "refs/tags/$tag"; then
              continue
            fi

            if [ ! -f "$changelog" ]; then
              echo "Missing $changelog; skipping $pkg_name"
              continue
            fi

            if ! grep -qE "^## \\[$version\\]" "$changelog"; then
              echo "No changelog entry for $pkg_name $version; skipping tag."
              continue
            fi

            echo "Creating tag $tag"
            git tag -a "$tag" -m "Release $tag"
            git push origin "$tag"
            created_any=true
            
            # Extract changelog for this version
            changelog_content=$(awk "/^## \\[$version\\]/,/^## \\[/" "$changelog" | head -n -1)
            
            # Create GitHub Release
            gh release create "$tag" \
              --title "$pkg_name v$version" \
              --notes "$changelog_content" \
              --verify-tag
            
            # Output which package was tagged for publishing
            echo "${pkg_name}=true" >> $GITHUB_OUTPUT
          done

          if [ "$created_any" = "false" ]; then
            echo "No tags to create."
          fi

  publish-kai_engine:
    needs: tag
    if: needs.tag.outputs.kai_engine == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dart-lang/setup-dart@v1
        with:
          sdk: stable
      - name: Publish kai_engine
        working-directory: packages/kai_engine
        run: |
          dart pub get
          dart pub publish --force

  publish-prompt_block:
    needs: tag
    if: needs.tag.outputs.prompt_block == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dart-lang/setup-dart@v1
        with:
          sdk: stable
      - name: Publish prompt_block
        working-directory: packages/prompt_block
        run: |
          dart pub get
          dart pub publish --force

  publish-kai_engine_firebase_ai:
    needs: [tag, publish-kai_engine]
    if: always() && needs.tag.outputs.kai_engine_firebase_ai == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dart-lang/setup-dart@v1
        with:
          sdk: stable
      - name: Publish kai_engine_firebase_ai
        working-directory: packages/kai_engine_firebase_ai
        run: |
          # If this release depends on a freshly-published kai_engine version,
          # pub.dev may take a short time to index it.
          for i in $(seq 1 10); do
            if dart pub get; then
              break
            fi
            echo "dart pub get failed (attempt $i/10), retrying..."
            sleep 15
          done
          dart pub publish --force

  publish-kai_engine_chat_ui:
    needs: [tag, publish-kai_engine]
    if: always() && needs.tag.outputs.kai_engine_chat_ui == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dart-lang/setup-dart@v1
        with:
          sdk: stable
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - name: Publish kai_engine_chat_ui
        working-directory: packages/kai_engine_chat_ui
        run: |
          flutter pub get
          flutter pub publish --force
