name: Publish to pub.dev

on:
  push:
    tags:
      - 'kai_engine-v*'
      - 'kai_engine_firebase_ai-v*'
      - 'kai_engine_chat_ui-v*'
      - 'prompt_block-v*'
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Validate tag ref
        run: |
          if [ "${{ github.ref_type }}" != "tag" ]; then
            echo "Error: This workflow must run from a tag ref"
            echo "Current ref: ${{ github.ref }} (type: ${{ github.ref_type }})"
            exit 1
          fi

      - uses: actions/checkout@v4

      - name: Determine package
        id: pkg
        run: |
          TAG="${{ github.ref_name }}"
          if [[ "$TAG" == kai_engine-v* ]]; then
            echo "name=kai_engine" >> $GITHUB_OUTPUT
            echo "type=dart" >> $GITHUB_OUTPUT
          elif [[ "$TAG" == kai_engine_firebase_ai-v* ]]; then
            echo "name=kai_engine_firebase_ai" >> $GITHUB_OUTPUT
            echo "type=dart" >> $GITHUB_OUTPUT
          elif [[ "$TAG" == kai_engine_chat_ui-v* ]]; then
            echo "name=kai_engine_chat_ui" >> $GITHUB_OUTPUT
            echo "type=flutter" >> $GITHUB_OUTPUT
          elif [[ "$TAG" == prompt_block-v* ]]; then
            echo "name=prompt_block" >> $GITHUB_OUTPUT
            echo "type=dart" >> $GITHUB_OUTPUT
          else
            echo "Unknown tag format: $TAG"
            exit 1
          fi

      - uses: dart-lang/setup-dart@v1
        if: steps.pkg.outputs.type == 'dart'
        with:
          sdk: stable

      - uses: subosito/flutter-action@v2
        if: steps.pkg.outputs.type == 'flutter'
        with:
          channel: stable
          cache: true

      - name: Publish ${{ steps.pkg.outputs.name }}
        working-directory: packages/${{ steps.pkg.outputs.name }}
        run: |
          PKG_TYPE="${{ steps.pkg.outputs.type }}"

          # Retry pub get in case dependencies were just published
          for i in $(seq 1 10); do
            if $PKG_TYPE pub get; then
              break
            fi
            echo "pub get failed (attempt $i/10), retrying..."
            sleep 15
          done

          $PKG_TYPE pub publish --force
