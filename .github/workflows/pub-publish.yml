name: Publish to pub.dev

on:
  push:
    tags:
      - 'kai_engine-v*'
      - 'kai_engine_firebase_ai-v*'
      - 'kai_engine_chat_ui-v*'
      - 'prompt_block-v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to publish (e.g. kai_engine-v1.0.0)'
        required: true
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  # Determine which package to publish based on tag
  resolve:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.resolve.outputs.tag }}
      package: ${{ steps.resolve.outputs.package }}
    steps:
      - name: Resolve tag
        id: resolve
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="${{ github.ref_name }}"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT

          if [[ "$TAG" == kai_engine-v* ]]; then
            echo "package=kai_engine" >> $GITHUB_OUTPUT
          elif [[ "$TAG" == kai_engine_firebase_ai-v* ]]; then
            echo "package=kai_engine_firebase_ai" >> $GITHUB_OUTPUT
          elif [[ "$TAG" == kai_engine_chat_ui-v* ]]; then
            echo "package=kai_engine_chat_ui" >> $GITHUB_OUTPUT
          elif [[ "$TAG" == prompt_block-v* ]]; then
            echo "package=prompt_block" >> $GITHUB_OUTPUT
          else
            echo "Unknown tag format: $TAG"
            exit 1
          fi

  publish-kai_engine:
    needs: resolve
    if: needs.resolve.outputs.package == 'kai_engine'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.resolve.outputs.tag }}
      - uses: dart-lang/setup-dart@v1
        with:
          sdk: stable
      - name: Publish kai_engine
        working-directory: packages/kai_engine
        run: |
          dart pub get
          dart pub publish --force

  publish-prompt_block:
    needs: resolve
    if: needs.resolve.outputs.package == 'prompt_block'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.resolve.outputs.tag }}
      - uses: dart-lang/setup-dart@v1
        with:
          sdk: stable
      - name: Publish prompt_block
        working-directory: packages/prompt_block
        run: |
          dart pub get
          dart pub publish --force

  publish-kai_engine_firebase_ai:
    needs: resolve
    if: needs.resolve.outputs.package == 'kai_engine_firebase_ai'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.resolve.outputs.tag }}
      - uses: dart-lang/setup-dart@v1
        with:
          sdk: stable
      - name: Publish kai_engine_firebase_ai
        working-directory: packages/kai_engine_firebase_ai
        run: |
          for i in $(seq 1 10); do
            if dart pub get; then
              break
            fi
            echo "dart pub get failed (attempt $i/10), retrying..."
            sleep 15
          done
          dart pub publish --force

  publish-kai_engine_chat_ui:
    needs: resolve
    if: needs.resolve.outputs.package == 'kai_engine_chat_ui'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.resolve.outputs.tag }}
      - uses: dart-lang/setup-dart@v1
        with:
          sdk: stable
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - name: Publish kai_engine_chat_ui
        working-directory: packages/kai_engine_chat_ui
        run: |
          flutter pub get
          flutter pub publish --force
